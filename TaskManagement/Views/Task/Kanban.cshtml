@model IEnumerable<TaskManagement.Models.Task>
@{
    ViewData["Title"] = "Kanban Board";
    var todo = Model.Where(t => t.Status == "Yapılacak").ToList();
    var inProgress = Model.Where(t => t.Status == "Devam Ediyor").ToList();
    var done = Model.Where(t => t.Status == "Tamamlandı").ToList();
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<h2 class="mb-4">Kanban Board</h2>
<div class="row" id="kanban-board">
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">Yapılacak</div>
            <div class="card-body min-vh-50" id="todo" ondrop="drop(event)" ondragover="allowDrop(event)">
                @foreach (var t in todo)
                {
                    <div class="kanban-task card mb-2 p-2" draggable="true" ondragstart="drag(event)" data-id="@t.Id">
                        <b>@t.Title</b><br />
                        <span class="badge bg-secondary">@t.DueDate?.ToString("yyyy-MM-dd")</span>
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">Devam Ediyor</div>
            <div class="card-body min-vh-50" id="inprogress" ondrop="drop(event)" ondragover="allowDrop(event)">
                @foreach (var t in inProgress)
                {
                    <div class="kanban-task card mb-2 p-2" draggable="true" ondragstart="drag(event)" data-id="@t.Id">
                        <b>@t.Title</b><br />
                        <span class="badge bg-secondary">@t.DueDate?.ToString("yyyy-MM-dd")</span>
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">Tamamlandı</div>
            <div class="card-body min-vh-50" id="done" ondrop="drop(event)" ondragover="allowDrop(event)">
                @foreach (var t in done)
                {
                    <div class="kanban-task card mb-2 p-2" draggable="true" ondragstart="drag(event)" data-id="@t.Id">
                        <b>@t.Title</b><br />
                        <span class="badge bg-secondary">@t.DueDate?.ToString("yyyy-MM-dd")</span>
                    </div>
                }
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.18/signalr.min.js"></script>
<script>
    let draggedId = null;
    function allowDrop(ev) {
        ev.preventDefault();
    }
    function drag(ev) {
        draggedId = ev.target.getAttribute('data-id');
    }
    function drop(ev) {
        ev.preventDefault();
        const statusMap = { 'todo': 'Yapılacak', 'inprogress': 'Devam Ediyor', 'done': 'Tamamlandı' };
        const col = ev.target.closest('.card-body');
        const newStatus = statusMap[col.id];
        if (draggedId && newStatus) {
            fetch('/Task/StatusUpdate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${draggedId}&status=${encodeURIComponent(newStatus)}`
            }).then(resp => {
                if (resp.ok) {
                    // Kartı yeni kolona taşı
                    const card = document.querySelector(`.kanban-task[data-id='${draggedId}']`);
                    col.appendChild(card);
                    // SignalR ile diğer kullanıcılara bildir
                    if (window.kanbanConnection) {
                        window.kanbanConnection.invoke('SendNotification', `Görev durumu güncellendi!`);
                    }
                }
            });
        }
    }

    // SignalR ile anlık bildirim (örnek)
    window.kanbanConnection = new signalR.HubConnectionBuilder()
        .withUrl('/notificationHub')
        .build();
    window.kanbanConnection.start();
</script>
<a href="/Task" class="btn btn-secondary mt-4">Görev Listesine Dön</a> 